# .github/actions/build-and-publish/action.yml
name: 'Build and Publish Docker Image'
description: 'Builds a Docker image and publishes it to GitHub Container Registry'

runs:
  using: 'composite'
  steps:
    - name: Set up Docker
      run: docker/setup-buildx-action@v1

    - name: Login to GitHub Container Registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Building image
      run: docker build -t ghcr.io/mohamad0880218/python:latest .

    - name: Testing image
      run: docker run -d --env-file ./instance/.env -p 5000:5000 --name python ghcr.io/mohamad0880218/python:latest

    - name: Push the package
      run: |
        docker stop python
        docker rm python
        docker push ghcr.io/mohamad0880218/python:latest
